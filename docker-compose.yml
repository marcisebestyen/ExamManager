services:
  database: 
    image: postgres:18
    ports:
      - "5433:5432"
    networks:
      - exam_net
    volumes:
      - ./postgres-data:/var/lib/postgresql
    environment:
      - POSTGRES_USER=adminuser
      - POSTGRES_PASSWORD=yourStrongPassword123!
      - POSTGRES_DB=examdb
    # PART 1: The Healthcheck
    # This runs the 'pg_isready' command inside the container every 5 seconds.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adminuser -d examdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend: 
    image: ghcr.io/marcisebestyen/exammanager
    ports: 
      - "7195:7195"
    networks:
      - exam_net
    environment:
      - ASPNETCORE_URLS=http://+:7195
      - ConnectionStrings__DefaultConnection=Host=database;Port=5432;Database=examdb;Username=adminuser;Password=yourStrongPassword123!
    # PART 2: The Condition
    # This pauses the backend startup until the database healthcheck passes.
    depends_on:
      database:
        condition: service_healthy

  frontend: 
    image: ghcr.io/marcisebestyen/exammanager-frontend
    ports: 
      - "7285:7285"
    networks:
      - exam_net
    environment:
      - BACKEND_URL=http://backend:7195
    command: npm run dev -- --host
    # Optional: Wait for backend to be ready (if backend had a healthcheck)
    depends_on:
      - backend

networks:
  exam_net:
    driver: bridge